name: Smoke

on:
  workflow_dispatch:
  pull_request:

jobs:
  smoke:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.x

      - name: Restore
        run: dotnet restore MAIN/VAL.csproj

      - name: Publish (win-x64)
        run: dotnet publish MAIN/VAL.csproj -c Release -r win-x64 -o artifacts/publish

      - name: Stage runtime content
        shell: pwsh
        run: |
          # Ensure clean staging targets (prevents nested folders like Modules\Modules or Dock\Dock)
          $publishRoot = "artifacts/publish"

          if (-not (Test-Path $publishRoot)) { throw "Publish output not found: $publishRoot" }

          # Always reset these to avoid residue across reruns
          Remove-Item -Recurse -Force (Join-Path $publishRoot "Modules") -ErrorAction SilentlyContinue
          Remove-Item -Recurse -Force (Join-Path $publishRoot "Dock")    -ErrorAction SilentlyContinue
          Remove-Item -Recurse -Force (Join-Path $publishRoot "Icons")   -ErrorAction SilentlyContinue

          New-Item -ItemType Directory -Force -Path (Join-Path $publishRoot "Modules") | Out-Null
          New-Item -ItemType Directory -Force -Path (Join-Path $publishRoot "Dock")    | Out-Null
          New-Item -ItemType Directory -Force -Path (Join-Path $publishRoot "Icons")   | Out-Null

          # ---- Modules ----
          $modulesSrc = "MAIN/Modules"
          if (Test-Path "MAIN/Modules/Modules") { $modulesSrc = "MAIN/Modules/Modules" }

          Copy-Item -Path (Join-Path $modulesSrc "*") -Destination (Join-Path $publishRoot "Modules") -Recurse -Force

          # ---- Dock ----
          $dockSrc = "MAIN/Dock"
          if (Test-Path "MAIN/Dock/Dock") { $dockSrc = "MAIN/Dock/Dock" }

          Copy-Item -Path (Join-Path $dockSrc "*") -Destination (Join-Path $publishRoot "Dock") -Recurse -Force

          # ---- Icons ----
          Copy-Item -Path "MAIN/Icons/*" -Destination (Join-Path $publishRoot "Icons") -Recurse -Force

          # ---- Config ----
          Copy-Item -Path "MAIN/appsettings.json" -Destination (Join-Path $publishRoot "appsettings.json") -Force
          if (Test-Path "MAIN/appsettings.Development.json") {
            Copy-Item -Path "MAIN/appsettings.Development.json" -Destination (Join-Path $publishRoot "appsettings.Development.json") -Force
          }

      - name: Run smoke
        shell: pwsh
        working-directory: artifacts/publish
        run: |
          $artifactsRoot = Resolve-Path ".."
          $smokeReport  = Join-Path $artifactsRoot "SmokeReport.txt"
          $smokeRun     = Join-Path $artifactsRoot "SmokeRun.txt"

          # Run and capture console output for debugging
          & .\VAL.exe --smoke --smoke-report-path "$smokeReport" 2>&1 | Tee-Object -FilePath $smokeRun
          $exitCode = $LASTEXITCODE

          # Ensure SmokeReport exists even if the app didn't write it
          if (-not (Test-Path $smokeReport)) {
            "SmokeReport.txt was not written by VAL.exe. See SmokeRun.txt for console output." | Out-File -FilePath $smokeReport -Encoding utf8
          }

          if ($exitCode -ne 0) {
            Write-Error "Smoke test failed with exit code $exitCode"
            exit $exitCode
          }

      - name: Collect crash logs
        if: always()
        shell: pwsh
        run: |
          $logRoot = Join-Path $env:LOCALAPPDATA "VAL\Logs"
          if (Test-Path $logRoot) {
            if (Test-Path (Join-Path $logRoot "CrashReport.txt")) {
              Copy-Item -Path (Join-Path $logRoot "CrashReport.txt") -Destination artifacts/CrashReport.txt -Force
            }
            if (Test-Path (Join-Path $logRoot "VAL.log")) {
              Copy-Item -Path (Join-Path $logRoot "VAL.log") -Destination artifacts/VAL.log -Force
            }
          }

      - name: Upload smoke artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-artifacts
          path: |
            artifacts/SmokeReport.txt
            artifacts/SmokeRun.txt
            artifacts/CrashReport.txt
            artifacts/VAL.log
            artifacts/publish/**
          if-no-files-found: warn
