name: Smoke

on:
  workflow_dispatch:
  pull_request:
  push:
    branches:
      - main

jobs:
  smoke:
    runs-on: windows-latest

    defaults:
      run:
        shell: pwsh

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.x

      - name: Restore
        run: dotnet restore MAIN/VAL.csproj

      - name: Publish (win-x64)
        run: dotnet publish MAIN/VAL.csproj -c Release -r win-x64 -o artifacts/publish

      - name: Stage runtime content
        run: |
          New-Item -ItemType Directory -Force -Path artifacts/publish | Out-Null

          # Copy runtime folders your app expects at runtime (only if they exist in the repo).
          $folders = @("Modules", "Dock", "Icons", "Images", "Themes", "Assets")
          foreach ($f in $folders) {
            $src = Join-Path "MAIN" $f
            $dst = Join-Path "artifacts/publish" $f
            if (Test-Path $src) {
              Copy-Item -Path $src -Destination $dst -Recurse -Force
            }
          }

          # Copy config files
          if (Test-Path "MAIN/appsettings.json") {
            Copy-Item -Path "MAIN/appsettings.json" -Destination "artifacts/publish/appsettings.json" -Force
          }
          if (Test-Path "MAIN/appsettings.Development.json") {
            Copy-Item -Path "MAIN/appsettings.Development.json" -Destination "artifacts/publish/appsettings.Development.json" -Force
          }

      - name: Run smoke
        id: run_smoke
        working-directory: artifacts/publish
        continue-on-error: true
        run: |
          $reportPath = Join-Path ".." "SmokeReport.txt"

          & ".\VAL.exe" --smoke --smoke-report-path $reportPath
          $exitCode = $LASTEXITCODE

          "exitCode=$exitCode" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          Write-Host "VAL smoke exit code: $exitCode"

      - name: Dump SmokeReport.txt
        if: always()
        run: |
          $p = "artifacts/SmokeReport.txt"
          if (Test-Path $p) {
            Write-Host "===== SmokeReport.txt ====="
            Get-Content -Path $p -Raw | Write-Host
            Write-Host "==========================="
          } else {
            Write-Host "No SmokeReport.txt found at $p"
          }

      - name: Collect crash logs
        if: always()
        run: |
          $logRoot = Join-Path $env:LOCALAPPDATA "VAL\Logs"

          if (Test-Path $logRoot) {
            New-Item -ItemType Directory -Force -Path artifacts | Out-Null

            $crash = Join-Path $logRoot "CrashReport.txt"
            if (Test-Path $crash) {
              Copy-Item -Path $crash -Destination artifacts/CrashReport.txt -Force
            }

            $valLog = Join-Path $logRoot "VAL.log"
            if (Test-Path $valLog) {
              Copy-Item -Path $valLog -Destination artifacts/VAL.log -Force
            }
          }

      - name: Upload smoke artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-artifacts
          path: |
            artifacts/SmokeReport.txt
            artifacts/CrashReport.txt
            artifacts/VAL.log
            artifacts/publish/**
          if-no-files-found: warn

      - name: Fail if smoke failed
        if: always()
        run: |
          $raw = "${{ steps.run_smoke.outputs.exitCode }}"
          $code = 1
          if ([int]::TryParse($raw, [ref]$code)) {
            # parsed
          } else {
            Write-Host "Could not parse exit code from '$raw' â€” defaulting to 1"
            $code = 1
          }

          if ($code -ne 0) {
            Write-Error "Smoke failed (exit code $code). See SmokeReport.txt / artifacts for details."
            exit $code
          }

          Write-Host "Smoke passed."
