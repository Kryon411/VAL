name: Smoke

on:
  workflow_dispatch:
  pull_request:
  push:
    branches:
      - main

jobs:
  smoke:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.x

      - name: Restore
        run: dotnet restore MAIN/VAL.csproj

      - name: Publish (win-x64)
        run: dotnet publish MAIN/VAL.csproj -c Release -r win-x64 -o artifacts/publish

      - name: Stage runtime content
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path artifacts/publish | Out-Null
          Copy-Item -Path "MAIN/Modules" -Destination "artifacts/publish/Modules" -Recurse -Force
          if (Test-Path "MAIN/Dock") {
            Copy-Item -Path "MAIN/Dock" -Destination "artifacts/publish/Dock" -Recurse -Force
          }
          Copy-Item -Path "MAIN/appsettings.json" -Destination "artifacts/publish/appsettings.json" -Force
          if (Test-Path "MAIN/appsettings.Development.json") {
            Copy-Item -Path "MAIN/appsettings.Development.json" -Destination "artifacts/publish/appsettings.Development.json" -Force
          }

      - name: Run smoke
        shell: pwsh
        working-directory: artifacts/publish
        run: |
          $artifactsRoot = Resolve-Path ".."
          $smokeReport = Join-Path $artifactsRoot "SmokeReport.txt"
          $smokeRun    = Join-Path $artifactsRoot "SmokeRun.txt"

          # Run and capture console output for debugging
          & ".\VAL.exe" --smoke --smoke-report-path "$smokeReport" 2>&1 | Tee-Object -FilePath $smokeRun
          $exitCode = $LASTEXITCODE

          # Ensure SmokeReport exists even if the app didn't write it
          if (-not (Test-Path $smokeReport)) {
            "SmokeReport.txt was not written by VAL.exe. See SmokeRun.txt for console output." | Out-File -FilePath $smokeReport -Encoding utf8
          }

          if ($exitCode -ne 0) {
            Write-Error "Smoke test failed with exit code $exitCode"
            exit $exitCode
          }

      - name: Collect crash logs
        if: always()
        shell: pwsh
        run: |
          $logRoot = Join-Path $env:LOCALAPPDATA "VAL\Logs"
          if (Test-Path $logRoot) {
            if (Test-Path (Join-Path $logRoot "CrashReport.txt")) {
              Copy-Item -Path (Join-Path $logRoot "CrashReport.txt") -Destination artifacts/CrashReport.txt -Force
            }
            if (Test-Path (Join-Path $logRoot "VAL.log")) {
              Copy-Item -Path (Join-Path $logRoot "VAL.log") -Destination artifacts/VAL.log -Force
            }
          }

      - name: Upload smoke artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-artifacts
          path: |
            artifacts/SmokeReport.txt
            artifacts/SmokeRun.txt
            artifacts/CrashReport.txt
            artifacts/VAL.log
            artifacts/publish/**
          if-no-files-found: warn
