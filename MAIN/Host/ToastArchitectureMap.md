# VAL (MAIN) — Toast architecture map

> Generated by code search over the uploaded `MAIN.zip` payload (all `.txt` sources).

## 1) Core toast renderer (WPF host)

### `MAIN/Host/ToastManager.cs.txt`
**Role:** The only place that *renders* toasts.

Key behaviors:
- `Initialize(Window w)` creates a `Popup` + `StackPanel` anchored bottom-right with safe insets.
- `ShowCatalog(...)` shows a text toast (title + optional subtitle).
- `ShowActions(...)` shows an action toast with buttons.
- **Burst dedupe:** `ShouldSuppressToast(title, subtitle)` suppresses identical toasts within **2s**.
- **Grouping:** `groupKey` + `replaceGroup` removes existing toasts in a group before showing new.
- **Launch quiet period:** `IsLaunchQuietPeriodActive` is `true` for the first **12s** after init.
- **Sticky:** `ToastDurationBucket.Sticky` never auto-dismisses.
- Special behavior: `ShowActions(...)` treats `groupKey == "continuum_guidance" && replaceGroup == true` as a "New Chat Assist" toast:
  - placed at the bottom of the stack
  - no auto-timeout (stays until user clicks)

## 2) Host integration points (WPF)

### `MAIN/MainWindow.xaml.cs.txt`
**Role:** Initializes the toast system and routes WebView messages into modules.

Toast usage:
- `MainWindow_Loaded(...)` calls `ToastManager.Initialize(this)`.
- `TryHandleVoidWebMessage(json)` handles `type:"void.command.set_enabled"` and shows:
  - **ON:** "Void is now on…" (L)
  - **OFF:** "Void is now off…" (M)
  - Includes its own "once per state change" gate: `_lastVoidEnabledToastState`.

Also important:
- `WebView_WebMessageReceived(...)` routes most messages to `ContinuumHost.HandleJson(json)`.

## 3) Continuum toast producer (host-side)

### `MAIN/Modules/Continuum/Pipeline/00_Common/ContinuumHost.cs.txt`
**Role:** The main toast producer for Continuum/Pulse/Chronicle/Prelude.

#### Toast catalog strings (defined at top)
- **Archiving:**
  - `Toast_ContinuumArchivingPaused`
- **Pulse:**
  - `Toast_PulseInitiated`, `Toast_PulseReady`
  - `Toast_PulseAlreadyRunning`, `Toast_PulseUnavailable`
  - `Toast_NoTruthLogFound`, `Toast_ActionUnavailable`
  - `Toast_OperationInProgress`, `Toast_OperationCancelled`
- **Chronicle:**
  - `Toast_ChronicleStarted`, `Toast_ChronicleCompleted`
  - `Toast_ChroniclePromptTitle`, `Toast_ChroniclePromptSubtitle`
  - `Toast_ChronicleSuggested`, `Toast_ChronicleUnavailable`
- **Prelude:**
  - `Toast_PreludeAvailable`
  - `Toast_PreludePromptTitle`, `Toast_PreludePromptSubtitle`

#### Toast groups used
- `"pulse"` — Pulse lifecycle (replaces itself)
- `"chronicle"` — Chronicle sticky + completion replacement
- `"continuum_guidance"` — guidance toasts (Prelude/Chronicle prompts)
- `"op.guard"` — generic op guard toast

#### Where toasts are triggered
- `continuum.command.toggle_logging` → shows **Paused** toast when disabling.
- `continuum.ui.prelude_prompt` → `ShowActions("Starting a new chat?", ...)` with **Prelude / Dismiss**.
- `continuum.ui.composer_interaction` → may show **Chronicle** action toast (once-per-chat + cooldown).
- `continuum.command.pulse` → Pulse toasts (initiated, ready, unavailable, etc.).
- `continuum.command.chronicle_rebuild_truth` → Chronicle sticky toast.
- `continuum.chronicle.done` → replaces sticky toast with completion toast.

#### Internal gating inside ContinuumHost
- Chronicle prompt gating:
  - requires meaningful chat + no Chronicle marker
  - cooldown `ChroniclePromptCooldown = 45s`
  - persisted gate: `ToastLedger.TryMarkShown(chatId, "guidance.chronicle_action_prompt")`
- Prelude prompt gating:
  - once per `href` on new chat root
  - suppressed during Pulse via `_suppressPreludeToastUntilUtc`

## 4) Once-per-chat persistence

### `MAIN/Modules/Continuum/Pipeline/00_Common/ToastLedger.cs.txt`
**Role:** A per-chat persisted set of shown toast IDs.

- Storage file: `<ChatDir>/ToastLedger.json`
- API:
  - `TryMarkShown(chatId, toastId)` (returns false if already shown)
  - `HasShown(chatId, toastId)`

Used by ContinuumHost + TelemetryThresholdMonitor.

## 5) Telemetry-driven toasts (session size)

### `MAIN/Modules/Continuum/Pipeline/06_Telemetry/Telemetry.ThresholdMonitor.cs.txt`
**Role:** Emits "conversation is getting large" nudges.

- Thresholds:
  - Soft: 800k bytes
  - Medium: 1.6M bytes
  - Critical: 2.8M bytes
- Uses `ToastLedger.TryMarkShown` so each level shows once per chat.
- Honors `ToastManager.IsLaunchQuietPeriodActive` (suppresses at startup).

## 6) Truth writer that indirectly triggers telemetry toasts

### `MAIN/Modules/Continuum/Pipeline/02_Truth/Truth.Storage.cs.txt`
**Role:** Appends to `Truth.log`.

Toast relevance:
- After successful append, calls `TryUpdateTelemetry(chatId, bytes)`.
- `TryUpdateTelemetry` invokes `TelemetryThresholdMonitor.UpdateFromTruthBytes` via reflection.

## 7) Client-side emitters (JS) that *cause* host-side toasts

### `MAIN/Dock/Dock.main.js.txt`
**Role:** Control Centre UI.

Toast-relevant messages it posts to host:
- `void.command.set_enabled` (Void toggle)
- `continuum.command.*` commands (Pulse, Chronicle, Prelude injection)
- `continuum.ui.new_chat` (route became `/` — currently suppressed host-side)

Also stores `VAL_PreludeNudgeSuppressUntil` to avoid new-chat prompts during Pulse.

### `MAIN/Modules/Continuum/Client/Continuum.Client.js.txt`
**Role:** Continuum DOM observer + signal emitter.

Toast-relevant emits:
- `continuum.ui.prelude_prompt` — when user clicks/types into a blank new-chat composer.
- `continuum.ui.composer_interaction` — when user interacts with composer in an existing chat.
